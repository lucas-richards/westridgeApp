{% extends "training/base_sidepanel.html" %}
{% load crispy_forms_tags %}
{% block content %}

<style>
    .sticky-column {
  position: sticky;
  left: 0;
  z-index: 1;
  background-color: rgb(249,249,249);
}
    
</style>

{% if user.is_authenticated %}
<h2>Dashboard</h2>

    <table class="table table-hover table-responsive" style="font-size: x-small;">
        <thead>
            <tr>
                <th class="sticky-column">Username</th>
                
                {% for training_module in training_modules %}
                        <th class="text-center">
                            <a href="{% url 'training-module-detail' training_module.id %}">
                            {{ training_module }}
                            </a>
                        </th>
                {% endfor %}
            
            </tr>
        </thead>
        <tbody>
            {% for row in data %}
                <tr>
                    <td class="sticky-column" style="width: 60px;">
                        {{ row.username }}
                        <div class="d-flex flex-wrap">
                            {% for role in row.roles %}
                                <span style="width: 20px;font-size: 5px;" class="badge bg-secondary text-white">{{ role }}</span>
                            {% endfor %}
                        </div>
                    </td>
                    {% for event in row.training_events %}
                        <td>
                            {% if event == '+' %}
                            <div class="d-flex justify-content-center align-items-center">
                                <a class="text-secondary">missing</a>
                            </div>
                            {% elif event.id %}
                            <a href="{% url 'training-event-detail' event.id %}" class="d-flex justify-content-center align-items-center text-dark">
                                {% if event.status == 'Expired' %}
                                <div data-toggle="tooltip" data-placement="right" title="{% if event.expiration_date %}Expired: {{ event.expiration_date|date:'n/j/Y'}}{% endif %}">
                                    <p class="text-danger">{{ event.status }}</p>
                                </div>
                                {% elif event.status == 'About to expire' %}
                                <div data-toggle="tooltip" data-placement="right" title="{% if event.expiration_date %}Expires in {{ event.expiration_date|timeuntil }}{% endif %}">
                                    <p class="text-warning">{{ event.status }}</p>
                                </div>
                                {% elif event.status == 'Ok' %}
                                    <p class="text-success">{{ event.completed_date|date:'n/j/Y' }}</p>
                                {% elif event.status == 'Incomplete' %}
                                    <p class="text-secondary">Incomplete</p>
                                {% else %}
                                {% endif %}
                                </a>
                            {% endif %}
                        </td>
                    {% endfor %}
                </tr>
            {% endfor %}
            
        </tbody>
    </table>

    {% if data.has_previous %}
        <a class="btn btn-outline-info mb-4" href="?page=1">First</a>
        <a class="btn btn-outline-info mb-4" href="?page={{ data.previous_page_number }}">Previous</a>
    {% endif %}

    {% for num in data.paginator.page_range %}
        {% if data.number == num %}
            <a class="btn btn-info mb-4" href="?page={{ num }}">{{ num }}</a>
        {% elif num > data.number|add:'-3' and num < data.number|add:'3' %}
            <a class="btn btn-outline-info mb-4" href="?page={{ num }}">{{ num }}</a>
        {% endif %}
    {% endfor %}

    {% if data.has_next %}
        <a class="btn btn-outline-info mb-4" href="?page={{ data.next_page_number }}">Next</a>
        <a class="btn btn-outline-info mb-4" href="?page={{ data.paginator.num_pages }}">Last</a>
    {% endif %}


    <div class="m-3">
        <form id="upload-form" method="post" action="{% url 'training-upload_file' %}" enctype="multipart/form-data">
            {% csrf_token %}
            {{ upload_form|crispy }}
            <button id="update" class="btn btn-sm btn-primary" type="submit">Update</button>
            
        </form>
        
    </div>
    <div id="loading-indicator" style="display: none;">
        <!-- Your loading indicator here (e.g., spinner or progress bar) -->
        <div class="spinner-grow" role="status">
            <span class="sr-only">Loading...</span>
        </div>
    </div>

    <!-- JavaScript to show loading indicator when form is submitted -->
    <script>
        document.getElementById("upload-form").addEventListener("submit", function() {
            document.getElementById("loading-indicator").style.display = "block";
            document.getElementById("upload-form").style.display = "none";
        });
    </script>
    

{% endif %}
    


{% endblock content %}